# ==============================================================================
# DOCKER COMPOSE - Week 17: Probabilistic Data Structures for Big Data
# ATP Course - ASE-CSIE Bucharest
# ==============================================================================
#
# This configuration provides a complete development environment for
# the Week 17 laboratory exercises on probabilistic data structures.
#
# Usage:
#   docker-compose up                 - Run demonstration
#   docker-compose run dev bash       - Interactive development shell
#   docker-compose run test           - Run all tests
#   docker-compose run benchmark      - Run benchmarks
#
# ==============================================================================

version: '3.8'

services:
  # Main demonstration service
  demo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-demo
    volumes:
      - ./data:/app/data:ro
      - ./logs:/app/logs
    environment:
      - DEMO_VERBOSE=1
    command: >
      sh -c "
        echo '═══════════════════════════════════════════════════════════════════' &&
        echo '     WEEK 17: PROBABILISTIC DATA STRUCTURES FOR BIG DATA' &&
        echo '═══════════════════════════════════════════════════════════════════' &&
        echo '' &&
        make run
      "

  # Development environment with interactive shell
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-dev
    stdin_open: true
    tty: true
    volumes:
      - .:/app
      - ./logs:/app/logs
    environment:
      - TERM=xterm-256color
    working_dir: /app
    command: /bin/bash

  # Test runner service
  test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-test
    volumes:
      - ./tests:/app/tests:ro
      - ./data:/app/data:ro
    command: >
      sh -c "
        echo 'Running automated tests...' &&
        make test &&
        echo '' &&
        echo 'All tests completed.'
      "

  # Memory check service (Valgrind)
  memcheck:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-memcheck
    command: >
      sh -c "
        echo 'Running memory leak checks...' &&
        make valgrind &&
        echo '' &&
        echo 'Memory check completed.'
      "

  # Benchmark service
  benchmark:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-benchmark
    volumes:
      - ./logs:/app/logs
    environment:
      - BENCHMARK_ITERATIONS=5
      - BENCHMARK_DATA_SIZE=100000
    command: >
      sh -c "
        echo '═══════════════════════════════════════════════════════════════════' &&
        echo '     PROBABILISTIC DATA STRUCTURES BENCHMARK' &&
        echo '═══════════════════════════════════════════════════════════════════' &&
        echo '' &&
        echo 'Configuration:' &&
        echo '  Iterations: $${BENCHMARK_ITERATIONS:-5}' &&
        echo '  Data size: $${BENCHMARK_DATA_SIZE:-100000}' &&
        echo '' &&
        make benchmark 2>/dev/null || ./example1 &&
        echo '' &&
        echo 'Benchmark completed.'
      "

  # Build all solutions (instructor use)
  solutions:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: week17-solutions
    volumes:
      - ./solution:/app/solution
    command: >
      sh -c "
        echo 'Building solution files...' &&
        make solutions &&
        echo 'Solutions built successfully.'
      "

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  logs:
    driver: local

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  default:
    name: week17-network
    driver: bridge

# ==============================================================================
# USAGE EXAMPLES
# ==============================================================================
#
# Run the main demonstration:
#   $ docker-compose up demo
#
# Start interactive development environment:
#   $ docker-compose run --rm dev
#
# Run all tests:
#   $ docker-compose run --rm test
#
# Check for memory leaks:
#   $ docker-compose run --rm memcheck
#
# Run benchmarks:
#   $ docker-compose run --rm benchmark
#
# Build solution files (instructor):
#   $ docker-compose run --rm solutions
#
# Clean up:
#   $ docker-compose down --volumes --remove-orphans
#
# Rebuild after changes:
#   $ docker-compose build --no-cache
#
# ==============================================================================
